---
phase: 07-seeded-prng
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/audio/engine.ts, src/audio/scheduler.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Seed value is visible in the UI during performance (not 'Random')"
    - "Displayed seed matches the manually entered seed after starting"
  artifacts:
    - path: "src/audio/engine.ts"
      provides: "Engine intercepts onStateChange to overlay seed"
    - path: "src/audio/scheduler.ts"
      provides: "Scheduler getState still returns seed: 0 (unchanged)"
  key_links:
    - from: "src/audio/engine.ts"
      to: "src/audio/scheduler.ts"
      via: "Engine wraps onStateChange callback to overlay currentSeed"
      pattern: "onStateChange.*seed.*currentSeed"
---

<objective>
Fix seed display showing "Random" instead of actual seed value during performance.

Purpose: Two UAT tests fail (tests 2 and 4) because Scheduler.fireStateChange() calls Scheduler.getState() which returns seed: 0, bypassing Engine.getState() seed overlay. Every beat sends seed: 0 to React, so SeedDisplay shows "Random".

Output: Engine intercepts the onStateChange callback to overlay currentSeed before passing state to React.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-seeded-prng/07-02-SUMMARY.md
@.planning/debug/resolved/seed-display-shows-random.md
@src/audio/engine.ts
@src/audio/scheduler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Engine intercepts onStateChange to overlay seed on every state update</name>
  <files>src/audio/engine.ts</files>
  <action>
Modify the Engine's `onStateChange` setter (line ~305) to wrap the caller's callback. Instead of passing the raw callback directly to `this.scheduler.onStateChange`, wrap it so every state change from the scheduler gets the seed overlaid before reaching React.

Change the setter to:
1. Store the raw callback in `this.pendingOnStateChange` (existing field, already used for pre-init storage)
2. Create a wrapper function that takes the scheduler's state, overlays `this.currentSeed` onto `state.seed`, then calls the raw callback
3. Assign the wrapper to `this.scheduler.onStateChange`

The wrapper pattern:
```typescript
set onStateChange(cb: ((state: EnsembleEngineState) => void) | null) {
  this.pendingOnStateChange = cb;
  if (this.scheduler) {
    this.scheduler.onStateChange = cb ? (state) => {
      state.seed = this.currentSeed;
      cb(state);
    } : null;
  }
}
```

Also update `initialize()` (line ~85-88) to apply the same wrapping pattern when connecting the pending callback after scheduler creation:
```typescript
if (this.pendingOnStateChange) {
  const cb = this.pendingOnStateChange;
  this.scheduler.onStateChange = (state) => {
    state.seed = this.currentSeed;
    cb(state);
  };
}
```

Also update `setScoreMode()` (line ~265) and `setPerformerCount()` (line ~158) which preserve and reconnect the callback after rebuilding the scheduler. These must also wrap the callback:
- In setScoreMode: where `callback` is restored (line ~284-286), wrap it the same way
- In setPerformerCount: where `callback` is restored (line ~179-181), wrap it the same way

Do NOT change scheduler.ts -- the seed: 0 placeholder in Scheduler.getState() is fine since Engine now intercepts all state changes.
  </action>
  <verify>
Run `npm test` -- all 32 tests pass.

Then verify manually: search engine.ts for all places where `this.scheduler.onStateChange` is assigned. Each assignment must use the wrapper pattern that overlays `this.currentSeed`. There should be no path where the raw callback is assigned directly to the scheduler.
  </verify>
  <done>
Every call to Scheduler.fireStateChange() now passes through Engine's wrapper, overlaying the real seed value before reaching React. SeedDisplay receives the actual seed (not 0) during performance, showing the numeric value instead of "Random".
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes (no regressions)
2. `grep -n "this.scheduler.onStateChange" src/audio/engine.ts` shows wrapper pattern at every assignment site
3. `grep -n "seed: 0" src/audio/scheduler.ts` still shows the placeholder (scheduler unchanged)
4. No direct assignment of raw callback to scheduler.onStateChange anywhere in engine.ts
</verification>

<success_criteria>
- Scheduler.fireStateChange() -> wrapper overlays currentSeed -> React receives real seed
- SeedDisplay shows actual numeric seed during performance (not "Random")
- Manually entered seed displays correctly after clicking Start
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/07-seeded-prng/07-03-SUMMARY.md`
</output>
