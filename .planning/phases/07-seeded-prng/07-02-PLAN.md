---
phase: 07-seeded-prng
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/audio/engine.ts
  - src/audio/types.ts
  - src/components/SeedDisplay.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "AudioEngine creates a SeededRng from the seed and passes it to Ensemble and getPatternsForMode"
    - "Same seed + mode + BPM + count produces identical note sequence on every run"
    - "Current seed is visible in the UI during and after performance"
    - "User can copy seed to clipboard with one click"
    - "User can type a seed to replay a specific performance"
    - "URL hash fragment encodes seed + mode + BPM + count"
    - "Opening a URL with hash fragment auto-configures mode, BPM, count, seed and shows Play button"
  artifacts:
    - path: "src/components/SeedDisplay.tsx"
      provides: "Seed display, copy, and input UI component"
      exports: ["SeedDisplay"]
    - path: "src/audio/engine.ts"
      provides: "Seed-aware engine with RNG creation and injection"
      contains: "SeededRng"
    - path: "src/audio/types.ts"
      provides: "Updated EnsembleEngineState with seed field"
      contains: "seed"
  key_links:
    - from: "src/audio/engine.ts"
      to: "src/score/rng.ts"
      via: "Creates SeededRng instance, passes to Ensemble and getPatternsForMode"
      pattern: "new SeededRng"
    - from: "src/App.tsx"
      to: "src/components/SeedDisplay.tsx"
      via: "Renders SeedDisplay with seed state and handlers"
      pattern: "<SeedDisplay"
    - from: "src/App.tsx"
      to: "window.location.hash"
      via: "Parses URL hash on mount, updates hash on performance start"
      pattern: "location\\.hash"
---

<objective>
Wire the seeded RNG through AudioEngine, add seed display/input UI, and implement URL hash encoding for shareable performances.

Purpose: Completes the user-facing seeded replay feature -- users can see, copy, enter seeds, and share URLs that reproduce identical performances.
Output: Full seed workflow from URL parsing through engine to UI display and sharing.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-seeded-prng/07-RESEARCH.md
@.planning/phases/07-seeded-prng/07-01-SUMMARY.md

@src/audio/engine.ts
@src/audio/types.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire SeededRng through AudioEngine and add seed to engine state</name>
  <files>src/audio/engine.ts, src/audio/types.ts</files>
  <action>
**src/audio/types.ts:**
- Add `seed: number` to `EnsembleEngineState` interface.

**src/audio/engine.ts:**
- Import `SeededRng` from `../score/rng.ts`.
- Add `private currentSeed: number = 0` field.
- Add `setSeed(seed: number): void` method that stores the seed for next performance start.
- Add `get seed(): number` getter that returns `this.currentSeed`.

**Seed lifecycle in engine:**

1. **`initialize()` / `start()`:** Before creating Ensemble and calling `getPatternsForMode()`:
   - If `this.currentSeed === 0`, generate: `this.currentSeed = Date.now() & 0xFFFFFFFF`.
   - Create `const rng = new SeededRng(this.currentSeed)`.
   - Pass `rng` to `getPatternsForMode(mode, rng)` to get patterns.
   - Pass `rng` to `new Ensemble(count, patterns, mode, velocityConfig, rng)`.

2. **`setScoreMode()`:** Same pattern -- if `currentSeed === 0`, generate seed; create RNG; pass to `getPatternsForMode` and `Ensemble`.

3. **`setPerformerCount()`:** Same pattern when rebuilding ensemble while stopped.

4. **`reset()`:** Set `this.currentSeed = 0` so next start generates a fresh seed.

5. **`getState()`:** Include `seed: this.currentSeed` in the returned `EnsembleEngineState`.

6. **`INITIAL_STATE` in App.tsx:** Add `seed: 0`.

**CRITICAL ordering:** The RNG must be created and used for `getPatternsForMode()` FIRST, then the SAME RNG instance passed to `Ensemble`. Pattern generation consumes RNG calls, and the Ensemble must continue from where pattern generation left off. This ensures the single PRNG stream is deterministic end-to-end.

Update the fallback state in `getState()` to include `seed: 0`.
  </action>
  <verify>
1. `npx tsc --noEmit` — no type errors
2. `npx vitest run` — all tests pass
3. Manual: start a performance, note the seed from console.log or state; reset; set the same seed; start again — same note sequence
  </verify>
  <done>AudioEngine creates SeededRng from seed, passes to getPatternsForMode and Ensemble. Seed is included in EnsembleEngineState. Reset clears seed for fresh generation. Same seed produces same performance.</done>
</task>

<task type="auto">
  <name>Task 2: Create SeedDisplay component and wire URL hash sharing in App.tsx</name>
  <files>src/components/SeedDisplay.tsx, src/App.tsx</files>
  <action>
**src/components/SeedDisplay.tsx:**

Create a component that shows the current seed and provides copy/input controls:

Props:
```typescript
interface SeedDisplayProps {
  seed: number;           // Current seed (0 = not yet generated)
  playing: boolean;       // Whether performance is active
  onSeedChange: (seed: number) => void;  // User enters a seed
}
```

Layout (fits the existing vertical flex layout of the app):
- Show seed as a monospace number when seed > 0 (during/after performance).
- "Copy" button next to the seed that copies `seed.toString()` to clipboard via `navigator.clipboard.writeText()`. Show brief "Copied!" feedback (1.5s timeout).
- "Share" button that copies the full URL (with hash fragment) to clipboard. Show brief "Link copied!" feedback.
- Text input for entering a seed manually. Accepts numeric input. On Enter or blur, call `onSeedChange(parsedSeed)`. Disable input while playing.
- When seed is 0 (before first performance), show placeholder text like "Seed: random" or similar.

Use existing styling patterns: shadcn Button component, Tailwind classes consistent with other components (text-sm, gap-2, etc.). Follow the aria-pressed and accessible patterns from HumanizationToggle/ScoreModeSelector.

**src/App.tsx:**

1. **URL hash parsing on mount:**
   - In the existing `useEffect([], ...)`, parse `window.location.hash`:
   ```typescript
   function parsePerformanceHash(): { seed: number; mode: ScoreMode; bpm: number; count: number } | null {
     const hash = window.location.hash.slice(1);
     if (!hash) return null;
     const params = new URLSearchParams(hash);
     const seed = params.get('seed');
     const mode = params.get('mode');
     const bpm = params.get('bpm');
     const count = params.get('count');
     if (!seed || !mode || !bpm || !count) return null;
     return { seed: parseInt(seed, 10), mode: mode as ScoreMode, bpm: parseInt(bpm, 10), count: parseInt(count, 10) };
   }
   ```
   - If hash config found: call `engine.setSeed(config.seed)`, `engine.setScoreMode(config.mode)`, `engine.setBpm(config.bpm)`, `engine.setPerformerCount(config.count)`, and update React state accordingly. Do NOT auto-start (autoplay policy). The user sees the pre-configured UI and clicks Start.

2. **URL hash update on performance start:**
   - After `handleStart()` completes, update `window.location.hash` with current config:
   ```typescript
   const state = engineRef.current.getState();
   const params = new URLSearchParams({
     seed: state.seed.toString(),
     mode: state.scoreMode,
     bpm: state.bpm.toString(),
     count: state.performerCount.toString(),
   });
   window.location.hash = params.toString();
   ```

3. **Seed change handler:**
   - Add `handleSeedChange` callback that calls `engineRef.current.setSeed(seed)`.
   - Disable seed input while playing.

4. **Render SeedDisplay:**
   - Place `<SeedDisplay>` in the layout, between Transport and ExportButton (or nearby logical position).
   - Pass `seed={engineState.seed}`, `playing={engineState.playing}`, `onSeedChange={handleSeedChange}`.

5. **Update INITIAL_STATE:** Add `seed: 0`.
  </action>
  <verify>
1. `npx tsc --noEmit` — no type errors
2. `npx vitest run` — all tests pass
3. Manual verification:
   - Start a performance → seed appears in UI
   - Click Copy → seed is in clipboard
   - Click Share → full URL with hash is in clipboard
   - Paste URL in new tab → mode/BPM/count/seed are pre-configured, click Play → same performance
   - Enter a seed manually → start → that seed is used
   - Reset → seed clears to 0 → next start generates fresh seed
  </verify>
  <done>SeedDisplay component shows seed, supports copy/share/input. URL hash encodes full performance config. Opening a shared URL auto-configures the UI. Manual seed entry works. All SEED-01 through SEED-06 requirements satisfied.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — clean compilation
2. `npx vitest run` — all tests pass
3. Start performance → seed visible in UI (SEED-02)
4. Copy button → seed in clipboard (SEED-03)
5. Enter seed manually → replay same performance (SEED-04)
6. Share button → URL with hash in clipboard (SEED-05)
7. Open shared URL → auto-configures, click Play → same performance (SEED-06)
8. Two runs with same seed+mode+BPM+count → identical note sequence (SEED-01)
</verification>

<success_criteria>
- Seed is displayed during and after performance
- One-click copy of seed to clipboard
- One-click copy of shareable URL to clipboard
- Manual seed entry replays specific performance
- URL hash encodes seed + mode + BPM + count
- Opening shared URL pre-configures everything, user clicks Play
- Same seed + config = identical performance every time
</success_criteria>

<output>
After completion, create `.planning/phases/07-seeded-prng/07-02-SUMMARY.md`
</output>
