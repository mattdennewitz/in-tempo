---
phase: 07-seeded-prng
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/score/rng.ts
  - src/score/rng.test.ts
  - src/score/ensemble.ts
  - src/score/generative.ts
  - src/score/euclidean.ts
  - src/score/velocity.ts
  - src/score/performer.ts
  - src/score/score-modes.ts
autonomous: true

must_haves:
  truths:
    - "SeededRng with same seed produces identical sequence of random() calls"
    - "All 32 Math.random() call sites in src/score/ replaced with SeededRng methods"
    - "No Math.random() calls remain in any src/score/ file"
    - "getPatternsForMode() accepts an optional RNG parameter and passes it to generators"
    - "Ensemble constructor accepts an optional RNG parameter and uses it for all randomness"
  artifacts:
    - path: "src/score/rng.ts"
      provides: "SeededRng class with Mulberry32 PRNG"
      exports: ["SeededRng"]
    - path: "src/score/rng.test.ts"
      provides: "Determinism and distribution tests"
      contains: "SeededRng"
  key_links:
    - from: "src/score/ensemble.ts"
      to: "src/score/rng.ts"
      via: "import SeededRng, use rng.random()/int()/pick()/weighted()"
      pattern: "rng\\.random\\(\\)|rng\\.int\\(|rng\\.pick\\(|rng\\.weighted\\("
    - from: "src/score/generative.ts"
      to: "src/score/rng.ts"
      via: "RNG parameter on generate function"
      pattern: "rng.*SeededRng"
    - from: "src/score/euclidean.ts"
      to: "src/score/rng.ts"
      via: "RNG parameter on generate function"
      pattern: "rng.*SeededRng"
    - from: "src/score/score-modes.ts"
      to: "src/score/rng.ts"
      via: "RNG parameter forwarded to generators"
      pattern: "rng.*SeededRng"
---

<objective>
Create the SeededRng class (Mulberry32) and replace all 32 Math.random() call sites across src/score/ with seeded RNG methods, ensuring deterministic performance output.

Purpose: This is the foundation for shareable performances -- without complete Math.random() replacement, same-seed replay is impossible.
Output: src/score/rng.ts with SeededRng class, all score files converted, determinism tests passing.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-seeded-prng/07-RESEARCH.md

@src/score/ensemble.ts
@src/score/generative.ts
@src/score/euclidean.ts
@src/score/velocity.ts
@src/score/performer.ts
@src/score/score-modes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SeededRng class with Mulberry32 and determinism tests</name>
  <files>src/score/rng.ts, src/score/rng.test.ts</files>
  <action>
Create `src/score/rng.ts` with a `SeededRng` class implementing Mulberry32:

```typescript
export class SeededRng {
  private state: number;
  constructor(seed: number) {
    this.state = (seed | 0) || 1; // Ensure non-zero initial state
  }
  random(): number { /* Mulberry32 -- see research Pattern 1 */ }
  int(min: number, max: number): number { /* inclusive range */ }
  pick<T>(arr: T[]): T { /* random element */ }
  weighted<T>(options: T[], weights: number[]): T { /* weighted selection */ }
}
```

Use the exact Mulberry32 implementation from research (Pattern 1). The `weighted()` method must match the semantics of the existing `weightedChoice()` in ensemble.ts (cumulative weights, fall through to last option).

Create `src/score/rng.test.ts` with:

1. **Determinism test:** Two SeededRng instances with same seed produce identical sequence of 1000 random() calls.
2. **Different seeds diverge:** Two instances with different seeds produce different sequences.
3. **int() range test:** 1000 calls to int(0, 10) all return values in [0, 10] inclusive.
4. **pick() test:** pick() returns elements from the provided array.
5. **weighted() test:** With weights [0, 0, 1], always picks the third option.
6. **Seed zero handling:** SeededRng(0) does not produce a degenerate zero sequence.

Run tests with `npx vitest run src/score/rng.test.ts`.
  </action>
  <verify>npx vitest run src/score/rng.test.ts — all tests pass</verify>
  <done>SeededRng class exists with random(), int(), pick(), weighted() methods. All 6 test cases pass. Seed 0 produces valid output.</done>
</task>

<task type="auto">
  <name>Task 2: Replace all Math.random() in score files with SeededRng</name>
  <files>src/score/ensemble.ts, src/score/generative.ts, src/score/euclidean.ts, src/score/velocity.ts, src/score/performer.ts, src/score/score-modes.ts</files>
  <action>
Replace all 32 Math.random() call sites using the inventory from research. The approach for each file:

**src/score/ensemble.ts (7 sites):**
- Add optional `rng?: SeededRng` parameter to `Ensemble` constructor. Store as `private rng: SeededRng`. Default to `new SeededRng(Date.now() & 0xFFFFFFFF)` if not provided.
- Replace the standalone `weightedChoice()` function to accept RNG: change `Math.random()` to `this.rng.random()` (or pass rng as parameter to the function).
- Replace `randomInRange()` calls for personality generation with `this.rng.random()`.
- Replace `Math.random()` in `randomReps()`, `handleEndgame()`, `rejoinLogic()`, constructor stagger, and `addAgent()`.
- The `computeVelocity()` call in tick() needs the RNG -- pass `this.rng` to `computeVelocity()`.
- Pass `this.rng` to `generateVelocityPersonality()` calls.

**src/score/generative.ts (8 sites):**
- Add optional `rng?: SeededRng` parameter to `generateGenerativePatterns()`.
- Default to `new SeededRng(Date.now() & 0xFFFFFFFF)` if not provided.
- Convert local `randInt()`, `pick()`, `weightedPick()` helpers to use `rng.int()`, `rng.pick()`, `rng.weighted()`.
- Replace remaining direct `Math.random()` calls (motif reuse, transform, rest, leap, pulse, motif bank) with `rng.random()`.

**src/score/euclidean.ts (10 sites):**
- Add optional `rng?: SeededRng` parameter to `generateEuclideanPatterns()`.
- Default to `new SeededRng(Date.now() & 0xFFFFFFFF)` if not provided.
- Replace all `Math.random()` calls in `rhythmToNotes()` and pattern generation with `rng.int()` and `rng.random()`.
- Pass `rng` to inner `rhythmToNotes()` calls.

**src/score/velocity.ts (3 sites):**
- Add optional `rng?: SeededRng` parameter to `computeVelocity()` and `generateVelocityPersonality()`.
- Default to `new SeededRng(Date.now() & 0xFFFFFFFF)` if not provided.
- Replace `Math.random()` in jitter, base loudness, jitter amount with `rng.random()`.

**src/score/performer.ts (2 sites):**
- Check if `Performer` class is still used in any active code path. If dead code, leave as-is (or convert for safety).
- If used: add optional `rng?: SeededRng` parameter, replace `Math.random()` in `randomRepetitions()` and rest logic.

**src/score/score-modes.ts:**
- Add optional `rng?: SeededRng` parameter to `getPatternsForMode()`.
- Forward `rng` to `generateGenerativePatterns(rng)` and `generateEuclideanPatterns(rng)`.
- Riley mode ignores RNG (returns static PATTERNS).

**CRITICAL:** After all conversions, run `grep -rn 'Math\.random' src/score/` to verify ZERO remaining calls. Any remaining `Math.random()` call is a determinism bug.

All existing parameters remain optional with sensible defaults so no existing call sites break. The engine will pass the RNG explicitly in Plan 02.
  </action>
  <verify>
1. `grep -rn 'Math\.random' src/score/` returns ZERO results (excluding test files and comments)
2. `npx vitest run` — all existing tests still pass
3. `npx tsc --noEmit` — no type errors
  </verify>
  <done>All 32 Math.random() call sites replaced with SeededRng methods. Zero Math.random() calls remain in src/score/ production code. All existing tests pass. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'Math\.random' src/score/` returns zero results (excluding test files)
2. `npx vitest run` — all tests pass including new rng.test.ts
3. `npx tsc --noEmit` — clean compilation
4. Two SeededRng(42) instances produce identical 1000-call sequences (tested in rng.test.ts)
</verification>

<success_criteria>
- SeededRng class exists with Mulberry32 implementation and convenience methods
- All 32 Math.random() call sites in src/score/ converted to use SeededRng
- Zero Math.random() calls remain in score production code
- All existing tests pass (no regressions)
- New determinism tests pass
- All parameters are optional with defaults so existing call sites don't break
</success_criteria>

<output>
After completion, create `.planning/phases/07-seeded-prng/07-01-SUMMARY.md`
</output>
