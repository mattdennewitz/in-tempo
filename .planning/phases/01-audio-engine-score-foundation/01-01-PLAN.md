---
phase: 01-audio-engine-score-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tsconfig.app.json
  - tsconfig.node.json
  - vite.config.ts
  - index.html
  - src/main.tsx
  - src/App.tsx
  - src/App.css
  - src/index.css
  - src/audio/types.ts
  - src/audio/worklet/synth-processor.js
  - public/synth-processor.js
  - src/score/patterns.ts
autonomous: true

must_haves:
  truths:
    - "Project runs with npm run dev and shows a blank React page in the browser"
    - "AudioWorklet processor file is loadable via URL at /synth-processor.js"
    - "All 53 Riley In C patterns are encoded as typed score data"
  artifacts:
    - path: "package.json"
      provides: "React 19 + TypeScript + Vite project configuration"
      contains: "react"
    - path: "src/audio/types.ts"
      provides: "Shared audio and score type definitions"
      exports: ["ScoreNote", "Pattern"]
    - path: "public/synth-processor.js"
      provides: "AudioWorkletProcessor for synthesis"
      contains: "registerProcessor"
    - path: "src/score/patterns.ts"
      provides: "All 53 In C patterns as typed data"
      exports: ["PATTERNS"]
      min_lines: 200
  key_links:
    - from: "src/score/patterns.ts"
      to: "src/audio/types.ts"
      via: "imports ScoreNote and Pattern types"
      pattern: "import.*from.*audio/types"
---

<objective>
Scaffold the Vite + React + TypeScript project, create the AudioWorklet synth processor, and encode all 53 of Riley's In C patterns as typed score data.

Purpose: Establishes the project foundation, audio synthesis capability, and musical content that all subsequent plans build on.
Output: Running Vite dev server, loadable worklet processor, complete score data file.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-engine-score-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Vite project and define audio types</name>
  <files>
    package.json
    tsconfig.json
    tsconfig.app.json
    tsconfig.node.json
    vite.config.ts
    index.html
    src/main.tsx
    src/App.tsx
    src/App.css
    src/index.css
    src/audio/types.ts
  </files>
  <action>
    Run `npm create vite@latest . -- --template react-ts` in the project root (the directory already exists, use `.` as the project name). Then `npm install`.

    Clean up the default Vite template: remove logo SVGs, clear out boilerplate content from App.tsx (replace with a simple div placeholder), simplify App.css and index.css to minimal resets (light background, centered content, clean sans-serif font).

    Create `src/audio/types.ts` with these type definitions:
    ```typescript
    export interface ScoreNote {
      midi: number;    // MIDI note number (0 for rest)
      duration: number; // duration in eighth notes
    }

    export interface Pattern {
      id: number;       // 1-53
      notes: ScoreNote[];
    }

    export interface EngineState {
      playing: boolean;
      currentPattern: number;
      bpm: number;
    }

    export type TransportCommand = 'start' | 'stop' | 'reset';
    ```

    Verify the dev server starts with `npm run dev` and the page loads without errors.
  </action>
  <verify>
    Run `npm run dev -- --host` briefly (or `npx vite build`) to confirm the project compiles without errors. Check that `src/audio/types.ts` exports the expected types by running `npx tsc --noEmit`.
  </verify>
  <done>
    Vite dev server starts cleanly, TypeScript compiles without errors, audio types are defined and exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AudioWorklet synth processor</name>
  <files>
    public/synth-processor.js
  </files>
  <action>
    Create `public/synth-processor.js` as a plain JavaScript file (NOT TypeScript -- AudioWorklet runs in a separate scope where TS compilation is problematic with Vite, per research pitfall #8).

    The processor implements a warm sine-based synthesizer per research discretion recommendation:
    - Two sine oscillators: one at the target frequency, one detuned ~3 cents sharp (frequency * 1.0017) for warmth
    - Simple envelope: instant attack, sustain while playing, exponential decay on noteOff (envelope *= 0.9995 per sample for ~200ms decay at 44.1kHz)
    - Gain controlled by envelope value
    - Mix both oscillators at equal level, total output scaled to 0.3 max to avoid clipping

    Message port handles:
    - `{ type: 'noteOn', frequency: number }` -- set frequency, set envelope to 1.0, set playing=true
    - `{ type: 'noteOff' }` -- set playing=false (envelope decays naturally)
    - `{ type: 'stop' }` -- immediate silence (envelope=0), used for hard stop on reset

    The processor returns `true` from process() always (keeps the node alive for voice pool reuse).

    Register as `registerProcessor('synth-processor', SynthProcessor)`.
  </action>
  <verify>
    Verify the file exists at `public/synth-processor.js` and contains `registerProcessor('synth-processor'`. The file should be plain JS (no import/export statements, no TypeScript syntax). Verify it's accessible by checking that `npx vite build` succeeds (Vite copies public/ files to dist/).
  </verify>
  <done>
    synth-processor.js in public/ directory implements dual-sine synthesis with envelope, handles noteOn/noteOff/stop messages, and registers as 'synth-processor'.
  </done>
</task>

<task type="auto">
  <name>Task 3: Encode all 53 Riley In C patterns as score data</name>
  <files>
    src/score/patterns.ts
  </files>
  <action>
    Create `src/score/patterns.ts` that exports a `PATTERNS` array of all 53 In C patterns, importing `ScoreNote` and `Pattern` types from `../audio/types`.

    Transcribe all 53 patterns from Terry Riley's published score. Key encoding rules:
    - MIDI note numbers: C4=60, D4=62, E4=64, F4=65, F#4=66, G4=67, A4=69, Bb4=70, B4=71, C5=72, D5=74, E5=76, F5=77, F#5=78, G5=79, A5=81, B5=83, C6=84
    - Duration in eighth-note units (1 = eighth note, 2 = quarter note, 4 = half note, 8 = whole note)
    - Rest represented as midi: 0
    - The score uses 9 of 12 chromatic pitches (no C#, Eb, Ab)

    Pattern reference highlights for validation:
    - Pattern 1: E4, F4 (two eighth notes) -- the simplest pattern
    - Pattern 2: E4 (eighth), F4 (eighth), F4 (held longer -- check score for exact duration)
    - Pattern 6: C5 held for several beats (a long sustained note)
    - Pattern 14: Introduces Bb (B-flat), marking a tonal shift
    - Pattern 22: Introduces F# for the first time
    - Pattern 29: Contains the lowest notes (going below middle C in some editions)
    - Pattern 35: The longest pattern (~60 eighth notes), spans 1.5 octaves -- most complex to encode
    - Pattern 48-53: Final patterns, simpler, winding down

    Add a helper function:
    ```typescript
    export function midiToFrequency(midi: number): number {
      return 440 * Math.pow(2, (midi - 69) / 12);
    }
    ```

    Also add `export const TOTAL_PATTERNS = 53;`

    IMPORTANT: Take care with the transcription. Cross-reference the published score carefully. Each pattern should be recognizable as melodic content, not random notes. If uncertain about a specific pattern's exact notes, encode the best interpretation and add a comment noting the uncertainty.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm type correctness. Verify: `PATTERNS.length === 53`, each pattern has `id` matching its 1-based index, each pattern has at least 1 note, all midi values are within reasonable range (0 or 48-96), all durations are positive integers. Pattern 1 should be `[{midi:64, duration:1}, {midi:65, duration:1}]` (E4, F4 eighths). Pattern 35 should have the most notes.
  </verify>
  <done>
    All 53 patterns encoded with correct MIDI values and durations. TypeScript compiles cleanly. PATTERNS array is exported and usable by performer logic.
  </done>
</task>

</tasks>

<verification>
- `npm run dev` starts without errors
- `npx tsc --noEmit` passes (all types correct)
- `npx vite build` succeeds (worklet file copied to dist/)
- `public/synth-processor.js` exists and contains registerProcessor
- `src/score/patterns.ts` exports PATTERNS with length 53
- `src/audio/types.ts` exports ScoreNote, Pattern, EngineState types
</verification>

<success_criteria>
Project scaffolded and running. AudioWorklet processor ready to load. All 53 In C patterns encoded as typed data. Zero TypeScript errors.
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-engine-score-foundation/01-01-SUMMARY.md`
</output>
