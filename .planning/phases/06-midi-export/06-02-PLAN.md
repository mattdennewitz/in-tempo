---
phase: 06-midi-export
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/ExportButton.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can see a download button in the UI"
    - "User can click the download button during or after playback and receive a .mid file"
    - "Download button is disabled when there is no recorded data"
    - "Opening the .mid file in a DAW shows one track per performer with correct pitches, durations, velocities, tempo, and instrument names"
  artifacts:
    - path: "src/components/ExportButton.tsx"
      provides: "MIDI export download button"
      min_lines: 15
    - path: "src/App.tsx"
      provides: "ExportButton wired into layout with engine.exportMidi callback"
      contains: "ExportButton"
    - path: "src/audio/types.ts"
      provides: "hasRecording field on EnsembleEngineState"
      contains: "hasRecording"
  key_links:
    - from: "src/components/ExportButton.tsx"
      to: "src/App.tsx"
      via: "onExport prop callback"
      pattern: "onExport"
    - from: "src/App.tsx"
      to: "src/audio/engine.ts"
      via: "engineRef.current.exportMidi()"
      pattern: "exportMidi"
---

<objective>
Create the ExportButton UI component, wire it into App.tsx, and verify the full MIDI export flow end-to-end by downloading and inspecting a .mid file.

Purpose: This completes the user-facing MIDI export feature. Users click a button, get a .mid file.
Output: ExportButton component, updated App.tsx, updated types.ts, and human verification that exported MIDI is correct.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-midi-export/06-RESEARCH.md
@.planning/phases/06-midi-export/06-01-SUMMARY.md
@src/App.tsx
@src/audio/engine.ts
@src/audio/types.ts
@src/components/HumanizationToggle.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportButton component and wire into App</name>
  <files>
    src/components/ExportButton.tsx
    src/App.tsx
  </files>
  <action>
    1. Create `src/components/ExportButton.tsx`:
       - Props: `{ onExport: () => void; disabled: boolean }`
       - Render a button styled consistently with the existing Transport component buttons (use shadcn Button or match existing Tailwind patterns from Transport.tsx)
       - Button text: "Export MIDI" (or a download icon + text)
       - Disabled when `disabled` prop is true (no recording available)
       - Use `aria-label="Export MIDI file"` for accessibility

    2. Update `src/App.tsx`:
       - Import ExportButton
       - Add `handleExport` callback: `engineRef.current.exportMidi()`
       - Render ExportButton after Transport controls, passing `onExport={handleExport}` and `disabled={!engineState.hasRecording}`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - `npm run dev` shows the Export MIDI button in the UI (disabled initially)
  </verify>
  <done>
    ExportButton renders in the UI, disabled when no recording exists, enabled after playback starts producing events. Clicking it triggers engine.exportMidi() which downloads a .mid file.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify MIDI export end-to-end</name>
  <what-built>Complete MIDI export pipeline: recording during playback, download button, multi-track .mid file with correct tempo, pitches, durations, velocities, and instrument assignments.</what-built>
  <how-to-verify>
    1. Run `npm run dev` and open the app in browser
    2. Click Start -- let the performance play for 10-15 seconds
    3. Click "Export MIDI" -- a .mid file should download
    4. Verify the filename format: `intempo-riley-120bpm-{timestamp}.mid`
    5. Open the .mid file in a DAW or MIDI viewer (e.g., https://signal.vercel.app/edit or any DAW)
    6. Check:
       a. Multiple tracks visible (one per performer, should be 4 tracks)
       b. Track names show "Performer N (instrument)"
       c. Notes have varying velocities (not all the same)
       d. BPM matches what was set in the app
    7. Stop playback, click "Export MIDI" again -- should still work (exports what was recorded)
    8. Click Reset -- the Export MIDI button should become disabled (no recording)
    9. Start a new performance at a different BPM (e.g., 140), let it play, export -- verify BPM in MIDI file is 140
    10. Test exporting during playback (mid-performance) -- should work and capture events up to that moment
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the exported MIDI file</resume-signal>
</task>

</tasks>

<verification>
- ExportButton visible in UI, properly enabled/disabled based on recording state
- Clicking Export MIDI triggers file download
- Downloaded .mid file opens in a DAW showing:
  - One track per performer (4 tracks with default settings)
  - Correct tempo metadata
  - GM instrument assignments (piano, marimba, synth pad)
  - Varied note velocities reflecting humanization
  - Correct note pitches and durations
- Export works both during and after playback
- Reset clears recording and disables the button
</verification>

<success_criteria>
- MIDI-01: User can download .mid at any point (during or after playback) -- VERIFIED
- MIDI-02: One track per performer with correct pitches and durations -- VERIFIED
- MIDI-03: Tempo metadata matches performance BPM -- VERIFIED
- MIDI-04: Each track has correct instrument program change -- VERIFIED
- MIDI-05: Per-note velocity reflects humanized values -- VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/06-midi-export/06-02-SUMMARY.md`
</output>
