---
phase: 03-visualization-instruments-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/canvas/theme.ts
  - src/canvas/renderer.ts
  - src/canvas/PerformerCanvas.tsx
  - src/components/ScoreModeSelector.tsx
  - src/index.css
  - src/components/PatternDisplay.tsx
autonomous: true

must_haves:
  truths:
    - "Each performer appears as a distinct visual element on a Canvas showing their current pattern number and playing/silent state"
    - "The UI uses the warm salmon / cream / dark navy color palette throughout"
    - "GT Canon font is declared with a fallback stack so the app works without font files"
    - "Score mode selector shows Riley's In C as default with future modes greyed out"
  artifacts:
    - path: "src/canvas/theme.ts"
      provides: "Color palette constants, font stack, layout metrics"
      contains: "PALETTE"
    - path: "src/canvas/renderer.ts"
      provides: "Pure Canvas draw functions for performer grid"
      exports: ["renderPerformers"]
    - path: "src/canvas/PerformerCanvas.tsx"
      provides: "React wrapper with useRef + requestAnimationFrame loop"
      min_lines: 30
    - path: "src/components/ScoreModeSelector.tsx"
      provides: "Score mode dropdown with Riley enabled, others disabled"
    - path: "src/index.css"
      provides: "GT Canon @font-face declarations, global palette application"
  key_links:
    - from: "src/canvas/PerformerCanvas.tsx"
      to: "src/canvas/renderer.ts"
      via: "import renderPerformers, called in rAF loop"
      pattern: "renderPerformers"
    - from: "src/canvas/renderer.ts"
      to: "src/canvas/theme.ts"
      via: "import PALETTE and FONT_STACK for drawing"
      pattern: "PALETTE|FONT_STACK"
---

<objective>
Canvas-based performer visualization with the InTempo visual identity (GT Canon font, salmon/cream/navy palette, score mode selector).

Purpose: Replace the basic CSS performer grid with an animated Canvas display that shows each performer as a distinct visual element with pattern number and status. Apply the editorial color palette and typography across the entire UI.

Output: Canvas renderer showing live performer state, full visual identity applied to all existing UI components, score mode selector stub.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-visualization-instruments-polish/03-RESEARCH.md
@.planning/phases/02-ensemble-ai/02-02-SUMMARY.md

Key existing files:
@src/audio/types.ts (PerformerState interface)
@src/App.tsx (current UI wiring)
@src/App.css (current styles to be replaced with palette)
@src/components/PatternDisplay.tsx (current performer grid -- replaced by Canvas)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Canvas theme, renderer, and PerformerCanvas component</name>
  <files>
    src/canvas/theme.ts
    src/canvas/renderer.ts
    src/canvas/PerformerCanvas.tsx
  </files>
  <action>
Create `src/canvas/theme.ts`:
- Export `PALETTE` constant with all colors from research: salmon (#E8735A), cream (#FDF6EE), navy (#1B2838), salmonLight (#F2A995), salmonMuted (#D4907E), warmGray (#B8AFA6), coolGray (#8C9196), paleGold (#E8D5B5), offWhite (#FAF8F5). Also playing/silent/complete state color mappings.
- Export `FONT_STACK` as `"'GT Canon', Georgia, 'Times New Roman', serif"` (fallback stack per research decision).
- Export layout constants: `CELL_WIDTH`, `CELL_HEIGHT`, `CELL_GAP`, `COLS` (4), `CELL_RADIUS` (corner radius for rounded rects).

Create `src/canvas/renderer.ts`:
- `setupCanvas(canvas: HTMLCanvasElement): CanvasRenderingContext2D` -- handles retina DPR scaling per research pattern (set canvas.width = clientWidth * dpr, ctx.scale(dpr, dpr)).
- `renderPerformers(ctx: CanvasRenderingContext2D, performers: PerformerState[], width: number, height: number): void` -- clears canvas, draws a grid of performer cards. Each card is a rounded rect with:
  - Fill color: offWhite for playing, warmGray at 30% opacity for silent, light warm gray for complete
  - Left accent bar in salmon (playing), warmGray (silent), or light gray (complete)
  - Performer ID label (small, coolGray text)
  - Pattern number (larger, navy text for playing, coolGray for silent/complete)
  - Status text ("P {n}" for playing with pattern n, "silent" for silent, "done" for complete)
- Grid layout: 4 columns, auto rows, centered within canvas width.
- Use `FONT_STACK` from theme for all text (check `document.fonts.check()` for GT Canon availability and fall back gracefully).
- Import PerformerState from `../audio/types.ts`.

Create `src/canvas/PerformerCanvas.tsx`:
- React component accepting `{ performers: PerformerState[] }` props.
- Uses `useRef` for canvas element and a `performersRef` that tracks latest performers array (avoids re-renders triggering rAF).
- `useEffect` starts a `requestAnimationFrame` loop that reads `performersRef.current` and calls `renderPerformers()`. Cleanup cancels rAF.
- Call `setupCanvas()` once on mount and on window resize (add resize listener).
- Canvas is styled with CSS: `width: 100%`, `max-width: 640px`, height auto-calculated from performer count (rows * cell height).
- Export the component.

IMPORTANT: The rAF loop must NOT call setState. It reads from the ref only.
  </action>
  <verify>
`npx tsc --noEmit` passes. The three new files exist in src/canvas/. PerformerCanvas accepts PerformerState[] and renders to canvas. The renderer uses PALETTE colors and FONT_STACK.
  </verify>
  <done>Canvas renderer draws a grid of performer cards with pattern numbers, status indicators, and correct palette colors. Retina-aware. Decoupled from React render cycle via rAF + refs.</done>
</task>

<task type="auto">
  <name>Task 2: Apply visual identity to UI and wire Canvas into App</name>
  <files>
    src/index.css
    src/App.css
    src/App.tsx
    src/components/ScoreModeSelector.tsx
    src/components/Transport.tsx
    src/components/BpmSlider.tsx
  </files>
  <action>
Update `src/index.css`:
- Add GT Canon @font-face declarations (Regular/400, Medium/500, Bold/700) pointing to `/fonts/GTCanon-*.woff2` with `font-display: swap`. These gracefully no-op if files are absent.
- Set `body` font-family to the fallback stack: `'GT Canon', Georgia, 'Times New Roman', serif`.
- Set `body` background to cream (#FDF6EE) and color to navy (#1B2838).

Update `src/App.css`:
- Replace all existing color values with palette equivalents:
  - Background: cream (#FDF6EE)
  - Text: navy (#1B2838)
  - Borders: warmGray (#B8AFA6)
  - Accent/active: salmon (#E8735A)
  - Disabled: coolGray (#8C9196)
- Update `.transport-btn` styles: border-color warmGray, hover salmon, start-btn uses salmon instead of green.
- Update `.bpm-slider` accent-color to salmon.
- Remove `.performer-grid`, `.performer-status`, `.performer-id`, `.performer-pattern`, `.performer-status--playing/silent/complete` classes (replaced by Canvas).
- Add `.score-mode-selector` styles: styled select/dropdown with palette colors.

Update `src/App.tsx`:
- Replace `PatternDisplay` import with `PerformerCanvas` from `./canvas/PerformerCanvas.tsx`.
- Add `ScoreModeSelector` component (disabled during playback).
- Layout: header area with title "InTempo" in navy, then PerformerCanvas, then controls row (Transport + BpmSlider + ScoreModeSelector).
- Keep PatternDisplay.tsx file intact but unused (may be removed later or kept for reference).

Create `src/components/ScoreModeSelector.tsx`:
- Dropdown/select with three options: "Riley's In C" (enabled, selected), "Generative" (disabled, shows "Coming soon"), "Euclidean" (disabled, shows "Coming soon").
- Accept `disabled` prop to disable during playback.
- Styled with palette colors per App.css classes.

Update `src/components/Transport.tsx` and `src/components/BpmSlider.tsx`:
- No functional changes needed. Visual changes come from the CSS updates in App.css. If they have inline styles, update to use palette colors.
  </action>
  <verify>
`npx tsc --noEmit` passes. `npm run build` succeeds. Run `npm run dev` and visually confirm: cream background, navy text, salmon accents on transport buttons, Canvas showing performer grid with pattern numbers and status colors. Score mode selector visible with "Riley's In C" selected and other options greyed out.
  </verify>
  <done>Full InTempo visual identity applied: GT Canon font (with fallback), salmon/cream/navy palette on all UI elements, Canvas performer display replaces CSS grid, score mode selector shows Riley as default. App looks cohesive and editorial.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. `npm run build` -- production build succeeds
3. Visual check: cream background, navy text, salmon accents throughout
4. Canvas shows 8 performer cards in a 4x2 grid with pattern numbers
5. Playing performers show salmon accent, silent show muted, complete show grey
6. Score mode selector shows "Riley's In C" selected, others disabled
7. All existing functionality (start/stop/reset/BPM) still works
</verification>

<success_criteria>
- Canvas displays all 8 performers with individual pattern numbers and status indicators
- Color palette (salmon/cream/navy) is applied consistently across all UI elements
- GT Canon @font-face declared with swap fallback (works without font files)
- Score mode selector renders with Riley as only enabled option
- No performance degradation from rAF loop (Canvas decoupled from React renders)
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualization-instruments-polish/03-01-SUMMARY.md`
</output>
