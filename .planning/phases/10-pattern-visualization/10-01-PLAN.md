---
phase: 10-pattern-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/audio/types.ts
  - src/audio/scheduler.ts
  - src/components/PatternDisplay.tsx
autonomous: true

must_haves:
  truths:
    - "Performer cards show a left-edge dot that flashes when a note is played, with intensity mapped to velocity"
    - "Performer cards show pattern position out of total (e.g. 12/53) during playback"
    - "Cards remain visually calm -- no flash/pulse/glow beyond the dot indicator"
  artifacts:
    - path: "src/audio/types.ts"
      provides: "lastHitVelocity field on PerformerState"
      contains: "lastHitVelocity"
    - path: "src/audio/scheduler.ts"
      provides: "Hit map computed from note events each beat"
      contains: "lastHitMap"
    - path: "src/components/PatternDisplay.tsx"
      provides: "Note-hit dot and pattern position display"
      contains: "lastHitVelocity"
  key_links:
    - from: "src/audio/scheduler.ts"
      to: "src/audio/types.ts"
      via: "lastHitVelocity merged into performer state in getState()"
      pattern: "lastHitMap\\.get"
    - from: "src/components/PatternDisplay.tsx"
      to: "src/audio/types.ts"
      via: "reads lastHitVelocity from PerformerState to set dot opacity"
      pattern: "lastHitVelocity"
---

<objective>
Extend the data layer to expose per-performer note-hit velocity and update performer cards with a note-hit dot indicator and pattern position display.

Purpose: VIZ-01 (note-hit feedback) and VIZ-02 (pattern progress) -- performers visually react to the music and show their position in the score.
Output: Performer cards with left-edge velocity dot and "pattern X/Y" display.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-pattern-visualization/10-CONTEXT.md
@.planning/phases/10-pattern-visualization/10-RESEARCH.md

@src/audio/types.ts
@src/audio/scheduler.ts
@src/components/PatternDisplay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lastHitVelocity to PerformerState and build hit map in Scheduler</name>
  <files>src/audio/types.ts, src/audio/scheduler.ts</files>
  <action>
In `src/audio/types.ts`:
- Add `lastHitVelocity?: number;` to the `PerformerState` interface (optional to avoid breaking existing construction sites in ensemble.ts). 0.0 = no hit this beat, 0.0-1.0 = velocity of the note played.

In `src/audio/scheduler.ts`:
- Add a private field `private lastHitMap: Map<number, number> = new Map();`
- In `scheduleBeat()`, BEFORE the event loop, clear the hit map: `this.lastHitMap.clear();`
- Inside the event loop (where `event.midi !== 0` is already checked), update the hit map with the max velocity per performer: `const current = this.lastHitMap.get(event.performerId) ?? 0; this.lastHitMap.set(event.performerId, Math.max(current, event.velocity));`
- In `getState()`, modify the `performers` field to merge hit data: `performers: this.ensemble.performerStates.map(p => ({ ...p, lastHitVelocity: this.lastHitMap.get(p.id) ?? 0 })),`

The hit map is rebuilt from scratch each beat, so performers that are sustaining (no new note event) will naturally have velocity 0. This ensures the dot disappears between beats per the "quick snap" decision.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify that the `lastHitMap` is cleared each beat and populated only for non-rest events.</verify>
  <done>PerformerState includes lastHitVelocity field. Scheduler computes per-performer max velocity each beat and merges it into getState() output. No compilation errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add note-hit dot and pattern position to performer cards</name>
  <files>src/components/PatternDisplay.tsx</files>
  <action>
Modify `PatternDisplay.tsx` to add two visual features per user decisions:

**Note-hit dot (VIZ-01):**
- Add a small dot element (`w-1.5 h-1.5 rounded-full bg-foreground`) as the FIRST child inside each active performer card div, positioned at the left edge.
- Set the dot's opacity to `performer.lastHitVelocity ?? 0` via inline style. This maps velocity to visual intensity per decision.
- Add `transition-opacity duration-100` class for the ~100ms snap animation per decision.
- Use `shrink-0` to prevent the dot from collapsing.
- Only render the dot for active performers during playback (not in ready state, not for inactive slots).
- No card-level flash/pulse/glow per decision -- the dot is the only visual feedback.

**Pattern position (VIZ-02):**
- Change the pattern display text from just `${performer.currentPattern}` to `${performer.currentPattern}/${totalPatterns}` to show position out of total.
- The `totalPatterns` prop is already passed to PatternDisplay. Currently it is unused (prefixed with _). Remove the underscore prefix and use it.
- Keep the rep counter (e.g. 2/5) as-is per decision.
- Rest state keeps the current "..." indicator per decision.
- "Done" text unchanged for complete performers.

The CARD constant width may need a small increase (from `w-[7.5rem]` to `w-[8.5rem]`) to accommodate the additional "/" + total text. Use your judgment on the exact width.
  </action>
  <verify>Run `npx tsc --noEmit` for type checks. Run `npm run dev` and start a performance to visually verify: (1) dots flash on the left edge of cards when notes play, (2) pattern position shows as "X/Y" format, (3) dots disappear between beats, (4) velocity maps to dot intensity.</verify>
  <done>Performer cards show a left-edge dot that flashes on note hits with velocity-mapped intensity. Pattern position displays as "X/Y" (e.g. "12/53"). Cards remain visually calm with no card-level effects.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Start a performance in any mode -- dots appear on left edge of performer cards in sync with audio
3. Dot intensity varies with note velocity (louder notes = brighter dot)
4. Dots disappear crisply between beats (~100ms transition)
5. Pattern position shows as "X/Y" format (e.g. "12/53" in Canon mode)
6. Silent performers show "..." with no dot visible
7. Complete performers show "Done" with no dot
8. Rep counter (e.g. "2/5") remains unchanged on the right side
</verification>

<success_criteria>
- VIZ-01 satisfied: performer cards flash a left-edge dot when a note plays, intensity mapped to velocity
- VIZ-02 satisfied: performer cards show pattern position out of total
- No visual regression to existing card layout
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/10-pattern-visualization/10-01-SUMMARY.md`
</output>
