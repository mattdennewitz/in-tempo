---
phase: 04-composition-modes
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/ScoreModeSelector.tsx
  - src/components/PatternDisplay.tsx
  - src/App.tsx
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "User sees mode selector with Riley (default), Generative, and Euclidean options with descriptions"
    - "Performer cards show player ID, current pattern, repetition progress (e.g. 1/4), status, and instrument"
    - "Mode badge is visible during performance showing current mode"
    - "totalPatterns comes from engine state, not hardcoded TOTAL_PATTERNS import"
    - "No canvas or PerformerCanvas references exist anywhere"
  artifacts:
    - path: "src/components/ScoreModeSelector.tsx"
      provides: "Score mode selector with three options and descriptions"
      exports: ["ScoreModeSelector"]
    - path: "src/components/PatternDisplay.tsx"
      provides: "Enhanced performer cards with rep/total display"
      contains: "currentRep"
    - path: "src/App.tsx"
      provides: "Mode state, setScoreMode handler, totalPatterns from engine state"
      contains: "setScoreMode"
    - path: "src/App.css"
      provides: "Styles for mode selector, enhanced performer cards, mode badge"
      contains: "score-mode"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/ScoreModeSelector.tsx"
      via: "renders ScoreModeSelector with mode state and onChange handler"
      pattern: "ScoreModeSelector"
    - from: "src/App.tsx"
      to: "AudioEngine.setScoreMode"
      via: "handleModeChange calls engine.setScoreMode"
      pattern: "setScoreMode"
    - from: "src/components/PatternDisplay.tsx"
      to: "PerformerState.currentRep"
      via: "displays currentRep/totalReps from performer state"
      pattern: "currentRep"
---

<objective>
Create the ScoreModeSelector UI component, enhance performer cards with repetition tracking, and wire mode switching through App.tsx.

Purpose: Completes the user-facing side of composition modes -- users can select modes, see descriptive options, and get richer performer status during playback.
Output: ScoreModeSelector component, enhanced PatternDisplay, wired App.tsx with mode state.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-composition-modes/04-CONTEXT.md
@.planning/phases/04-composition-modes/04-01-SUMMARY.md
@src/App.tsx
@src/App.css
@src/components/PatternDisplay.tsx
@src/audio/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScoreModeSelector Component</name>
  <files>src/components/ScoreModeSelector.tsx, src/App.css</files>
  <action>
**Create `src/components/ScoreModeSelector.tsx`:**

Props interface:
```typescript
interface ScoreModeSelectorProps {
  currentMode: ScoreMode;
  onChange: (mode: ScoreMode) => void;
  disabled?: boolean; // Optional: could disable during playback if desired
}
```

Render three selectable options (buttons or radio-style cards) for:
1. **Riley** -- "Terry Riley's 53 original patterns from In C (1964)"
2. **Generative** -- "Algorithmically generated melodic cells inspired by minimalism"
3. **Euclidean** -- "Rhythmic patterns generated by Bjorklund's Euclidean algorithm"

Each option shows:
- Mode name (Riley / Generative / Euclidean)
- Description text below the name
- Visual selected state (highlighted border or background for active mode)

Layout: horizontal row of 3 cards on desktop, stack vertically on mobile (use CSS media query or container query). Style to match existing app aesthetic (the `#213547` text, `#4a8c6f` accent, clean borders).

Import `ScoreMode` from `../audio/types.ts`.

**Add CSS to `src/App.css`:**

Style `.score-mode-selector` container as a flex row with gap.
Style `.score-mode-option` cards with border, padding, cursor pointer, hover state.
Style `.score-mode-option--active` with accent border color (`#4a8c6f`) and subtle background.
Style `.score-mode-name` as bold label.
Style `.score-mode-description` as smaller muted text.
Add responsive breakpoint: below 640px, stack options vertically.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Component renders without runtime errors when imported.
  </verify>
  <done>
ScoreModeSelector renders three mode options with names, descriptions, and visual selected state. Calls onChange when user clicks a different mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhanced Performer Cards + Mode Badge + App Wiring</name>
  <files>src/components/PatternDisplay.tsx, src/App.tsx, src/App.css</files>
  <action>
**Update `src/components/PatternDisplay.tsx`:**

1. Update props interface to receive `scoreMode: ScoreMode` in addition to existing props.

2. Enhance each performer card to show (per CONTEXT.md "Player N - pattern - rep/total" format):
   - Player ID: `Player {id + 1}` (currently shows `P{id + 1}`, change to `Player`)
   - Current pattern number (already shown)
   - Repetition progress: `{currentRep}/{totalReps}` -- access from PerformerState (added in Plan 01)
   - Status indicator: playing/silent/complete (already exists via opacity)
   - For silent performers: show "..." for pattern and rep
   - For complete performers: show "Done"

3. Add a subtle mode badge at the top of the display area showing current mode name (e.g., "Riley", "Generative", "Euclidean"). Use a small pill/badge styled element. This satisfies the "Mode indicator: Subtle badge visible during performance" requirement.

4. Remove any references to PerformerCanvas or canvas if they exist (check imports, JSX). Per CONTEXT.md: "Remove PerformerCanvas / canvas visualization entirely."

**Update `src/App.tsx`:**

1. Add imports:
   - `import { ScoreModeSelector } from './components/ScoreModeSelector.tsx';`
   - `import type { ScoreMode } from './audio/types.ts';`

2. Remove `import { TOTAL_PATTERNS } from './score/patterns.ts';` -- totalPatterns now comes from engine state.

3. Add state: `const [scoreMode, setScoreMode] = useState<ScoreMode>('riley');`
   Add state: `const [totalPatterns, setTotalPatterns] = useState(53);`

4. Update the onStateChange callback to also extract `scoreMode` and `totalPatterns` from engine state (these fields were added to EnsembleEngineState in Plan 01 / Plan 02):
   ```
   setScoreMode(state.scoreMode);
   setTotalPatterns(state.totalPatterns);
   ```

5. Add mode change handler:
   ```typescript
   const handleModeChange = useCallback((mode: ScoreMode) => {
     engineRef.current.setScoreMode(mode);
   }, []);
   ```

6. Render `<ScoreModeSelector>` above the PatternDisplay:
   ```jsx
   <ScoreModeSelector
     currentMode={scoreMode}
     onChange={handleModeChange}
   />
   ```

7. Pass `scoreMode` to PatternDisplay:
   ```jsx
   <PatternDisplay
     performers={performers}
     playing={playing}
     ensembleComplete={ensembleComplete}
     totalPatterns={totalPatterns}
     scoreMode={scoreMode}
   />
   ```

**Add CSS to `src/App.css`:**

Style the mode badge (`.mode-badge`): small pill, muted background, small font, positioned at top of pattern display.

Update `.performer-status` card styles for enhanced layout:
- Adjust to accommodate the longer "Player N" label and "rep/total" display
- Use a mini grid or flexbox within each card: `player-id | pattern-num | rep-progress`
- Add `.performer-rep` style for the repetition counter (smaller, muted text)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npx vite build` -- builds successfully.
Grep for "TOTAL_PATTERNS" in App.tsx -- should not be found (replaced by engine state).
Grep for "PerformerCanvas" or "canvas" in src/ -- should not be found.
  </verify>
  <done>
ScoreModeSelector is rendered and wired to AudioEngine.setScoreMode. Performer cards show player ID, pattern, rep/total, and status. Mode badge displays during performance. No canvas references remain. totalPatterns sourced from engine state.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vite build` succeeds
- No references to `TOTAL_PATTERNS` in App.tsx
- No references to `PerformerCanvas` or canvas visualization anywhere in src/
- ScoreModeSelector renders three options with descriptions
- Performer cards show rep/total information
- Mode badge visible in pattern display area
</verification>

<success_criteria>
- User can see and click between Riley, Generative, and Euclidean mode options
- Each option has a descriptive subtitle
- Selected mode is visually highlighted
- Performer cards show "Player N - pattern - rep/total" format
- Mode badge shows current mode during performance
- totalPatterns is dynamic (from engine state, not hardcoded)
- No canvas/PerformerCanvas references remain
</success_criteria>

<output>
After completion, create `.planning/phases/04-composition-modes/04-03-SUMMARY.md`
</output>
