---
phase: 05-velocity-humanization
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/HumanizationToggle.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle humanization on/off before or during playback"
    - "User can select intensity level (subtle/moderate/expressive) before or during playback"
    - "Toggling humanization off produces uniform velocity (all notes same loudness)"
    - "Toggling humanization back on restores varied dynamics"
    - "Intensity change is audible: expressive has clearly wider dynamic range than subtle"
  artifacts:
    - path: "src/components/HumanizationToggle.tsx"
      provides: "UI toggle for humanization on/off and intensity selector"
      exports: ["HumanizationToggle"]
    - path: "src/App.tsx"
      provides: "Wiring of HumanizationToggle to AudioEngine"
      contains: "HumanizationToggle"
  key_links:
    - from: "src/components/HumanizationToggle.tsx"
      to: "src/App.tsx"
      via: "onToggle and onIntensityChange callbacks"
      pattern: "handleHumanization"
    - from: "src/App.tsx"
      to: "src/audio/engine.ts"
      via: "engine.setHumanization() and engine.setHumanizationIntensity()"
      pattern: "setHumanization"
---

<objective>
Add the humanization UI toggle and verify the full velocity pipeline end-to-end with user listening.

Purpose: VEL-05 requires user-accessible controls. This plan adds the UI component and includes a human verification checkpoint to confirm the velocity variation is audible and the controls work as expected.

Output: HumanizationToggle component wired to AudioEngine, verified by ear.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-velocity-humanization/05-RESEARCH.md
@.planning/phases/05-velocity-humanization/05-02-SUMMARY.md
@src/App.tsx
@src/components/Transport.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HumanizationToggle component and wire into App</name>
  <files>src/components/HumanizationToggle.tsx, src/App.tsx</files>
  <action>
    **src/components/HumanizationToggle.tsx:**
    Create a new component matching the app's existing styling patterns (check Transport.tsx, BpmSlider.tsx for conventions).

    Props:
    ```typescript
    interface HumanizationToggleProps {
      enabled: boolean;
      intensity: 'subtle' | 'moderate' | 'expressive';
      onToggle: () => void;
      onIntensityChange: (intensity: 'subtle' | 'moderate' | 'expressive') => void;
    }
    ```

    Layout:
    - A row with a toggle button ("Humanize: On" / "Humanize: Off")
    - When enabled, show three intensity buttons (Subtle / Moderate / Expressive) with the active one visually distinguished (e.g., different background/border like ScoreModeSelector uses aria-pressed)
    - Use Tailwind classes consistent with existing components
    - Keep it compact — this sits alongside other controls in the main layout

    **src/App.tsx:**
    1. Import HumanizationToggle.
    2. Add handlers:
       ```typescript
       const handleHumanizationToggle = useCallback(() => {
         engineRef.current.setHumanization(!engineState.humanizationEnabled);
       }, [engineState.humanizationEnabled]);

       const handleIntensityChange = useCallback((intensity: 'subtle' | 'moderate' | 'expressive') => {
         engineRef.current.setHumanizationIntensity(intensity);
       }, []);
       ```
    3. Render HumanizationToggle in the layout between PerformerControls and BpmSlider (or wherever it fits naturally):
       ```tsx
       <HumanizationToggle
         enabled={engineState.humanizationEnabled}
         intensity={engineState.humanizationIntensity}
         onToggle={handleHumanizationToggle}
         onIntensityChange={handleIntensityChange}
       />
       ```
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    ```
    Component renders without errors. Toggle and intensity buttons are visible.
  </verify>
  <done>HumanizationToggle component renders in the app layout with on/off toggle and intensity selector. Clicking toggle calls engine.setHumanization(). Clicking intensity buttons calls engine.setHumanizationIntensity().</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify velocity humanization end-to-end</name>
  <files>src/App.tsx</files>
  <action>
    Human listens to playback and verifies velocity humanization is audible and controls work correctly.
    This is a listening checkpoint — no code changes, just verification that the full pipeline sounds musical.
  </action>
  <verify>
    1. Run `npm run dev` and open the app in browser
    2. **Default performer count (CFG-01):** Confirm the app starts with 4 performers (not 8)
    3. **Humanization audible (VEL-01):** Click Start with default settings (Humanize: On, Moderate). Listen for ~10 seconds. Notes should have audibly varied dynamics — not uniform/mechanical.
    4. **Personality difference (VEL-02):** Listen for distinct dynamic character between performers. Some should sound generally louder, others softer.
    5. **Toggle off:** Click "Humanize: Off". All notes should sound uniform (same loudness). Toggle back on — variation should return.
    6. **Intensity levels:** Try Subtle (minimal variation), then Expressive (wide dynamic range). Expressive should have clearly more contrast between loud and soft notes.
    7. **Metric accent (VEL-03):** Listen for slight emphasis on pattern starts (first note of each pattern iteration slightly louder).
    8. **Phrase contour (VEL-04):** This is subtle — over multiple repetitions of a pattern, dynamics should gently swell then recede (not random fluctuation).
    9. **Reset preserves settings:** Toggle to Expressive, click Reset, click Start. Should still be Expressive.
    10. **Mode switch:** Switch score mode to Generative or Euclidean. Velocity humanization should still work.
  </verify>
  <done>User confirms velocity variation is audible and musically pleasant. Toggle and intensity controls work before and during playback. All three instrument types respond to velocity. 4 performers by default. Settings survive reset and mode switch.</done>
</task>

</tasks>

<verification>
- App compiles and runs (`npm run dev`)
- HumanizationToggle visible and interactive
- Velocity variation audible in playback
- Toggle on/off produces clear difference
- Intensity levels produce perceptible difference
- All three instrument types (synth, piano, marimba) respond to velocity
- Default 4 performers
</verification>

<success_criteria>
- User confirms velocity humanization is audible and musically pleasant
- Toggle and intensity controls work before and during playback
- 4 performers by default
- Settings survive reset and mode switch
</success_criteria>

<output>
After completion, create `.planning/phases/05-velocity-humanization/05-03-SUMMARY.md`
</output>
